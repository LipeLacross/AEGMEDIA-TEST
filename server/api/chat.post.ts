// server/api/chat.post.ts - Vers√£o OTIMIZADA com Fluxo Simplificado
import { HfInference } from '@huggingface/inference'

// === INTERFACES E TIPOS ===
interface ChatMessage {
  role: 'user' | 'assistant' | 'system'
  content: string
}

interface ChatRequest {
  message: string
  context?: ChatMessage[]
  sessionId?: string
}

interface ChatResponse {
  reply: string
  timestamp: string
  context: ChatMessage[]
  error?: boolean
  debug?: string
}

// Interface para dados do usu√°rio
interface UserData {
  nome?: string
  veiculo?: string
  ano?: string
  valor?: number
  telefone?: string
  cidade?: string
  confirmedData?: boolean
}

// Estados simplificados da conversa
enum ConversationState {
  INITIAL = 'initial',
  COLLECTING_DATA = 'collecting_data',
  CONFIRMING_DATA = 'confirming_data',
  ANSWERING_QUESTIONS = 'answering_questions',
  GENERATING_OFFER = 'generating_offer'
}

interface ConversationContext {
  state: ConversationState
  userData: UserData
  questionsAnswered: Set<string>
  offerGenerated: boolean
}
function answerSpecificQuestion(message: string): string {
  const lowerMessage = message.toLowerCase()

  // Perguntas sobre n√∫mero/telefone
  if (lowerMessage.includes('numero') || lowerMessage.includes('n√∫mero') ||
      lowerMessage.includes('telefone') || lowerMessage.includes('contato')) {
    return `üìû **Nossos Contatos AutoShield:**

‚Ä¢ **WhatsApp**: (74) 98125-6120
‚Ä¢ **Telefone**: (74) 98125-6120  
‚Ä¢ **Email**: contato@autoshield.com.br

üïê **Atendimento**: 24 horas por dia, 7 dias por semana

Prefere falar pelo WhatsApp? √â s√≥ clicar: https://wa.me/5574981256120`
  }

  // Perguntas sobre cria√ß√£o/funda√ß√£o
  if (lowerMessage.includes('criou') || lowerMessage.includes('fundou') ||
      lowerMessage.includes('quem criou')) {
    return `üè¢ **Sobre a AutoShield:**

A AutoShield √© uma empresa brasileira fundada em 2023, especializada em prote√ß√£o veicular com tecnologia de ponta.

‚ú® **Nosso diferencial**: Somos pioneiros na integra√ß√£o de IA com rastreamento veicular no Brasil.

üéØ **Miss√£o**: Oferecer prote√ß√£o veicular inteligente e acess√≠vel para todos os brasileiros.

Quer saber mais sobre nossos servi√ßos?`
  }

  return ''
}
function generateFallbackResponse(message: string): string {
  return `ü§î N√£o encontrei informa√ß√µes espec√≠ficas sobre "${message}".

üìû **Para d√∫vidas n√£o listadas, fale conosco:**
‚Ä¢ WhatsApp: (74) 98125-6120
‚Ä¢ Email: contato@autoshield.com.br

üí° **Posso ajudar com:**
‚Ä¢ Planos e pre√ßos detalhados
‚Ä¢ Coberturas espec√≠ficas
‚Ä¢ Processo de contrata√ß√£o
‚Ä¢ Informa√ß√µes sobre a empresa

O que gostaria de saber?`
}

// === CONFIGURA√á√ïES OTIMIZADAS ===
const CONFIG = {
  MAX_RETRIES: 2,
  TIMEOUT_MS: 6000,
  RETRY_DELAY_MS: 1000,
  MAX_SESSIONS: 50,
  MAX_CONTEXT_MESSAGES: 15, // Otimizado para 15 mensagens
  SESSION_TTL_MS: 20 * 60 * 1000 // 20 minutos
} as const

const STABLE_MODELS = [
  'google/gemma-2-2b-it',
  'meta-llama/Meta-Llama-3-8B-Instruct',
  'mistralai/Mistral-7B-Instruct-v0.2'
] as const

// === BANCO DE CONHECIMENTO DA EMPRESA ===
const COMPANY_KNOWLEDGE = {
  contato: {
    telefone: "(74) 98125-6120",
    whatsapp: "(74) 98125-6120",
    email: "contato@autoshield.com.br",
    site: "www.autoshield.com.br",
    endereco: "S√£o Paulo, SP - Brasil"
  },

  empresa: {
    nome: "AutoShield",
    fundacao: "2023",
    criador: "Empresa brasileira especializada em prote√ß√£o veicular",
    missao: "Oferecer prote√ß√£o veicular inteligente com tecnologia de ponta",
    diferencial: "Primeira empresa a integrar IA no rastreamento veicular no Brasil"
  },

  planos: {
    essencial: {
      preco: "R$ 89/m√™s",
      descricao: "Cobertura roubo/furto, GPS gr√°tis, assist√™ncia 24h, guincho at√© 200km, cobertura vidros",
      ideal_para: "Ve√≠culos at√© R$ 50.000"
    },
    completo: {
      preco: "R$ 149/m√™s",
      descricao: "Tudo do Essencial + colis√£o, inc√™ndio, terceiros R$ 50k, carro reserva 15 dias",
      ideal_para: "Ve√≠culos at√© R$ 100.000"
    },
    premium: {
      preco: "R$ 229/m√™s",
      descricao: "Tudo do Completo + fen√¥menos naturais, terceiros R$ 100k, carro reserva premium 30 dias",
      ideal_para: "Ve√≠culos at√© R$ 200.000"
    }
  },

  cobertura: {
    basica: "Roubo, furto, assist√™ncia 24h, guincho, chaveiro, vidros",
    completa: "Colis√£o, inc√™ndio, fen√¥menos naturais, terceiros",
    diferencial: "Rastreamento GPS com IA gratuito em todos os planos"
  },

  tecnologia: {
    gps_ia: "Sistema de rastreamento com intelig√™ncia artificial integrada",
    app: "Aplicativo exclusivo para clientes com monitoramento em tempo real",
    assistencia: "Central 24h com atendimento automatizado por IA"
  }
}

// === FUN√á√ïES DE AN√ÅLISE E RESPOSTA ===

// Detecta se √© pergunta sobre a empresa
function isCompanyQuestion(message: string): boolean {
  const questionKeywords = ['como', 'que', 'qual', 'quando', 'onde', 'por que', 'quanto', '?']
  const companyKeywords = ['autoshield', 'empresa', 'plano', 'pre√ßo', 'cobertura', 'assist√™ncia', 'guincho']

  const hasQuestion = questionKeywords.some(word => message.toLowerCase().includes(word))
  const hasCompanyTopic = companyKeywords.some(word => message.toLowerCase().includes(word))

  return hasQuestion && hasCompanyTopic
}

// Responde perguntas sobre a empresa
function answerCompanyQuestion(message: string): string {
  const lowerMessage = message.toLowerCase()

  if (lowerMessage.includes('pre√ßo') || lowerMessage.includes('valor') || lowerMessage.includes('quanto custa')) {
    return `üí∞ **Nossos Planos AutoShield:**

‚Ä¢ **Essencial**: R$ 89/m√™s - Prote√ß√£o completa b√°sica
‚Ä¢ **Completo**: R$ 149/m√™s - Prote√ß√£o total + benef√≠cios
‚Ä¢ **Premium**: R$ 229/m√™s - M√°xima prote√ß√£o VIP

üéÅ **Todos incluem GPS com IA GR√ÅTIS!**

Qual plano te interessa mais?`
  }

  if (lowerMessage.includes('cobertura') || lowerMessage.includes('cobre') || lowerMessage.includes('protege')) {
    return `üõ°Ô∏è **Nossa Cobertura Completa:**

‚úÖ Roubo e Furto total
‚úÖ Colis√£o e Inc√™ndio  
‚úÖ Assist√™ncia 24h em todo Brasil
‚úÖ Guincho ilimitado
‚úÖ Rastreamento GPS com IA
‚úÖ Cobertura de terceiros
‚úÖ Chaveiro e vidros

Quer saber mais sobre alguma cobertura espec√≠fica?`
  }

  if (lowerMessage.includes('assist√™ncia') || lowerMessage.includes('guincho') || lowerMessage.includes('24h')) {
    return `üöó **Assist√™ncia 24h AutoShield:**

‚Ä¢ Guincho ilimitado em todo Brasil
‚Ä¢ Chaveiro emergencial
‚Ä¢ Pane seca e el√©trica
‚Ä¢ Mec√¢nico no local
‚Ä¢ Assist√™ncia m√©dica
‚Ä¢ Carro reserva (planos Completo/Premium)

**SEM CAR√äNCIA** para assist√™ncia! Dispon√≠vel imediatamente ap√≥s aprova√ß√£o.

Precisa de mais alguma informa√ß√£o?`
  }

  if (lowerMessage.includes('diferencial') || lowerMessage.includes('vantagem') || lowerMessage.includes('melhor')) {
    return `üåü **Nossos Diferenciais √önicos:**

üî• GPS com IA **GRATUITO** (valor R$ 50/m√™s)
‚ö° Sem car√™ncia para guincho e assist√™ncia
üí∞ Pre√ßos transparentes, sem taxas ocultas
üöÄ Atendimento com IA 24h no app
üì± Cancelamento livre, sem multas
üèÜ 4.8‚≠ê de avalia√ß√£o no Google

Qual diferencial mais te chama aten√ß√£o?`
  }

  // Resposta gen√©rica para outras perguntas
  return `üìã **Sobre a AutoShield:**

Somos especialistas em prote√ß√£o veicular com tecnologia de ponta. Oferecemos 3 planos (R$ 89, R$ 149, R$ 229) com cobertura completa e assist√™ncia 24h.

**Principais d√∫vidas:**
‚Ä¢ Pre√ßos e planos
‚Ä¢ Coberturas inclu√≠das  
‚Ä¢ Assist√™ncia 24h
‚Ä¢ Nossos diferenciais

Sobre o que gostaria de saber mais?`
}

// Extra√ß√£o otimizada de dados
function extractUserData(currentData: UserData, message: string): UserData {
  const updatedData = { ...currentData }

  // Nome
  const nomePatterns = [
    /(?:meu nome √©|me chamo|sou o|sou a)\s+([a-z√°√†√¢√£√©√®√™√≠√Ø√≥√¥√µ√∂√∫√ß√±\s]+)/i,
    /^([a-z√°√†√¢√£√©√®√™√≠√Ø√≥√¥√µ√∂√∫√ß√±]{3,})\s*$/i
  ]

  for (const pattern of nomePatterns) {
    const match = message.match(pattern)
    if (match && match[1] && !updatedData.nome) {
      updatedData.nome = match[1].trim()
      break
    }
  }

  // Ve√≠culo
  const veiculoPatterns = [
    /(?:tenho um|meu carro √©|dirigir um)\s+([a-z√°√†√¢√£√©√®√™√≠√Ø√≥√¥√µ√∂√∫√ß√±\s\d]+)/i,
    /(civic|corolla|onix|hb20|gol|uno|palio|fiesta|ka|celta|prisma)/i
  ]

  for (const pattern of veiculoPatterns) {
    const match = message.match(pattern)
    if (match && match[1] && !updatedData.veiculo) {
      updatedData.veiculo = match[1].trim()
      break
    }
  }

  // Telefone
  const telefoneMatch = message.match(/(\(?[1-9]{2}\)?\s?9?\d{4}-?\d{4})/g)
  if (telefoneMatch && !updatedData.telefone) {
    updatedData.telefone = telefoneMatch[0]
  }

  // Ano
  const anoMatch = message.match(/(20\d{2}|19\d{2})/g)
  if (anoMatch && !updatedData.ano) {
    const ano = parseInt(anoMatch[0])
    if (ano >= 1990 && ano <= 2025) {
      updatedData.ano = ano.toString()
    }
  }

  // Valor simplificado
  const valorMatch = message.match(/(\d+\.?\d*)\s*(?:mil|k)/i)
  if (valorMatch && valorMatch[1] && !updatedData.valor) {
    updatedData.valor = parseInt(valorMatch[1]) * 1000
  }


  return updatedData
}

// Verifica se tem dados suficientes (simplificado)
function hasSufficientData(userData: UserData): boolean {
  return !!(userData.nome && userData.veiculo && userData.telefone)
}

// Gera link do WhatsApp otimizado
function generateWhatsAppLink(userData: UserData): string {
  const baseMessage = `Ol√°! Sou ${userData.nome}. Tenho interesse na prote√ß√£o AutoShield para meu ${userData.veiculo}${userData.ano ? ` (${userData.ano})` : ''}. Gostaria de uma proposta personalizada.`

  return `https://wa.me/5574981256120?text=${encodeURIComponent(baseMessage)}`
}

// === IMPLEMENTA√á√ÉO PRINCIPAL OTIMIZADA ===
const hf = new HfInference(process.env.HUGGINGFACE_TOKEN)
const conversationMemory = new Map<string, ConversationContext>()

export default defineEventHandler(async (event): Promise<ChatResponse> => {
  try {
    const body = await readBody<ChatRequest>(event)
    const { message } = body
    let context = body.context || []
    let sessionId = body.sessionId || Math.random().toString(36).substring(2, 15)

    // Valida√ß√£o
    if (!message?.trim()) {
      throw createError({
        statusCode: 400,
        statusMessage: 'Mensagem √© obrigat√≥ria'
      })
    }

    // Recuperar ou criar contexto
    let conversationContext: ConversationContext
    if (conversationMemory.has(sessionId)) {
      conversationContext = conversationMemory.get(sessionId)!
    } else {
      conversationContext = {
        state: ConversationState.INITIAL,
        userData: {},
        questionsAnswered: new Set(),
        offerGenerated: false
      }
    }

    let reply = ''

    // === FLUXO OTIMIZADO DE CONVERSA ===

    // 1. PRIMEIRA PRIORIDADE: Responder d√∫vidas sobre a empresa
    if (isCompanyQuestion(message)) {
      conversationContext.state = ConversationState.ANSWERING_QUESTIONS
      reply = answerCompanyQuestion(message)

      // Ap√≥s responder, sugere avan√ßar se j√° tiver alguns dados
      if (Object.keys(conversationContext.userData).length > 0) {
        reply += `\n\nüí¨ J√° que voc√™ tem interesse, que tal finalizarmos sua proposta rapidinho?`
      }
    }
    // 2. FLUXO DE QUALIFICA√á√ÉO SIMPLIFICADO
    else {
      switch (conversationContext.state) {
        case ConversationState.INITIAL:
        case ConversationState.ANSWERING_QUESTIONS:
          // Extrair dados da mensagem atual
          conversationContext.userData = extractUserData(conversationContext.userData, message)

          if (hasSufficientData(conversationContext.userData)) {
            // Dados suficientes - pular para confirma√ß√£o
            conversationContext.state = ConversationState.CONFIRMING_DATA
            reply = `‚úÖ Perfeito! Vou confirmar seus dados:

üìù **Seus Dados:**
‚Ä¢ Nome: ${conversationContext.userData.nome}
‚Ä¢ Ve√≠culo: ${conversationContext.userData.veiculo}${conversationContext.userData.ano ? ` (${conversationContext.userData.ano})` : ''}
‚Ä¢ WhatsApp: ${conversationContext.userData.telefone}

Est√° tudo correto? Digite **SIM** para continuar ou **N√ÉO** para corrigir.`
          } else {
            // Coletar dados que faltam de forma inteligente
            conversationContext.state = ConversationState.COLLECTING_DATA
            const missingData = []

            if (!conversationContext.userData.nome) missingData.push('seu nome')
            if (!conversationContext.userData.veiculo) missingData.push('seu ve√≠culo (marca/modelo)')
            if (!conversationContext.userData.telefone) missingData.push('seu WhatsApp')

            if (missingData.length === 3) {
              reply = `üëã Ol√°! Sou o consultor AutoShield. Para criar sua proposta personalizada, preciso apenas de:

üìã **Me conte rapidinho:**
‚Ä¢ Seu nome
‚Ä¢ Que carro voc√™ tem
‚Ä¢ Seu WhatsApp

Pode mandar tudo numa mensagem s√≥! üòâ`
            } else {
              reply = `üìã Quase pronto! S√≥ preciso de mais: **${missingData.join(' e ')}**.

Pode me informar?`
            }
          }
          break

        case ConversationState.COLLECTING_DATA:
          // Continuar coletando dados
          conversationContext.userData = extractUserData(conversationContext.userData, message)

          if (hasSufficientData(conversationContext.userData)) {
            conversationContext.state = ConversationState.CONFIRMING_DATA
            reply = `‚úÖ √ìtimo! Confirmando seus dados:

üìù **Seus Dados:**
‚Ä¢ Nome: ${conversationContext.userData.nome}
‚Ä¢ Ve√≠culo: ${conversationContext.userData.veiculo}${conversationContext.userData.ano ? ` (${conversationContext.userData.ano})` : ''}
‚Ä¢ WhatsApp: ${conversationContext.userData.telefone}

Est√° correto? **SIM** ou **N√ÉO**?`
          } else {
            const missingData = []
            if (!conversationContext.userData.nome) missingData.push('nome')
            if (!conversationContext.userData.veiculo) missingData.push('ve√≠culo')
            if (!conversationContext.userData.telefone) missingData.push('WhatsApp')

            reply = `üìã Ainda preciso de: **${missingData.join(', ')}**. Pode completar para mim?`
          }
          break

        case ConversationState.CONFIRMING_DATA:
          if (message.toLowerCase().includes('sim')) {
            conversationContext.state = ConversationState.GENERATING_OFFER
            const whatsappLink = generateWhatsAppLink(conversationContext.userData)

            reply = `üéâ **Proposta AutoShield para ${conversationContext.userData.nome}!**

üî• **OFERTA ESPECIAL:**
‚Ä¢ 15% OFF na primeira parcela
‚Ä¢ GPS com IA GRATUITO (valor R$ 50/m√™s)
‚Ä¢ Sem car√™ncia para assist√™ncia
‚Ä¢ Cobertura imediata

üí∞ **Planos dispon√≠veis:**
‚Ä¢ Essencial: R$ 89/m√™s
‚Ä¢ Completo: R$ 149/m√™s  
‚Ä¢ Premium: R$ 229/m√™s

üì± **Finalize agora pelo WhatsApp:**
${whatsappLink}

Nossa equipe especializada vai atender voc√™ em segundos! üöÄ`

            conversationContext.offerGenerated = true
          } else if (message.toLowerCase().includes('n√£o')) {
            conversationContext.state = ConversationState.COLLECTING_DATA
            reply = `‚úèÔ∏è Sem problema! O que precisa corrigir?

‚Ä¢ **Nome**: ${conversationContext.userData.nome || 'n√£o informado'}
‚Ä¢ **Ve√≠culo**: ${conversationContext.userData.veiculo || 'n√£o informado'}  
‚Ä¢ **WhatsApp**: ${conversationContext.userData.telefone || 'n√£o informado'}

Me diga o que est√° errado.`
          } else {
            reply = `ü§î Por favor, responda **SIM** para confirmar ou **N√ÉO** para corrigir os dados.`
          }
          break

        case ConversationState.GENERATING_OFFER:
          reply = `‚úÖ Sua proposta j√° foi gerada!

üì± **Link direto do WhatsApp:**
${generateWhatsAppLink(conversationContext.userData)}

Tem alguma d√∫vida sobre nossos planos ou coberturas?`
          break
      }
    }

    // Garantir que sempre h√° uma resposta
    if (!reply) {
      reply = `üëã Ol√°! Sou o assistente AutoShield. Como posso ajudar?

ü§î **Posso esclarecer sobre:**
‚Ä¢ Planos e pre√ßos
‚Ä¢ Coberturas e assist√™ncia
‚Ä¢ Fazer sua cota√ß√£o

O que gostaria de saber?`
    }

    // Atualizar contexto com limite otimizado
    const newContext: ChatMessage[] = [
      ...context.slice(-(CONFIG.MAX_CONTEXT_MESSAGES - 2)), // Manter espa√ßo para as novas mensagens
      { role: 'user' as const, content: message },
      { role: 'assistant' as const, content: reply }
    ]

    // Salvar contexto da conversa
    conversationMemory.set(sessionId, conversationContext)

    return {
      reply: reply,
      timestamp: new Date().toISOString(),
      context: newContext
    }

  } catch (error: unknown) {
    console.error('‚ùå Erro na API:', error)
    return {
      reply: `üö® Sistema temporariamente indispon√≠vel.

üìû **Contato direto:**
WhatsApp: (74) 98125-6120

Nossa equipe est√° pronta para atender voc√™!`,
      context: [],
      error: true,
      timestamp: new Date().toISOString()
    }
  }
})
